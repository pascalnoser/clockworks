#' Run ARSER rhythmicity detection
#'
#' @param inputs Inputs for rhythmicity detection function generated by
#'   `prepare_arser()`
#' @param grp Group that is being analysed
#' @param method_args Additional parameters passed to `MetaCycle::meta2d()`
#'
#' @importFrom MetaCycle meta2d
#'
#' @returns A list
execute_arser <- function(inputs, grp, method_args = list()) {
  # TODO: Figure out what to do about `parallelize` and `nCores`

  # Combine and overwrite inputs with method_args
  inputs <- utils::modifyList(inputs, method_args)

  # Ensure `cycMethod = "ARS"` and print message if set manually
  inputs$cycMethod = "ARS"
  if (!is.null(method_args$cycMethod) && method_args$cycMethod != "ARS") {
    message(
      paste0(
        "'ARSER' was selected as the 'method', but the 'cycMethod' argument in ",
        "`MetaCycle::meta2d()` was manually set to '",
        method_args$cycMethod,
        "'. The specified 'method' will take precendce and the defined ",
        "'cycMethod' will be ignored. To use a different algorithm, please set ",
        "the 'method' argument of clockworks accordingly."
      )
    )
  }

  # Run rhythmicity analysis
  ls_res <- do.call(MetaCycle::meta2d, inputs)

  # Add feature IDs and group to results
  ls_res <- lapply(ls_res, function(x) {
    if (is.data.frame(x)) cbind(x, group = grp)
  })

  # Return results
  return(ls_res)
}
